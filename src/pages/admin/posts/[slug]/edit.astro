---
export const prerender = false;

import AdminLayout from '../../../../components/AdminLayout.astro';
import { getPost, savePost, validatePostData } from '../../../../utils/admin.ts';

// Obtener el slug de la URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/admin/posts');
}

// Obtener el post existente
const existingPost = await getPost(slug);

if (!existingPost) {
  return Astro.redirect('/admin/posts?error=Post not found');
}

let message = '';
let messageType = '';
let formData = {
  title: existingPost.data.title,
  description: existingPost.data.description,
  date: existingPost.data.date,
  categories: existingPost.data.categories?.join(', ') || '',
  published: existingPost.data.published,
  thumbnail: existingPost.data.thumbnail || '',
  content: existingPost.data.content
};

// Manejar actualizaci√≥n de post
if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData();
    
    const postData = {
      title: (data.get('title') as string) || '',
      description: (data.get('description') as string) || '',
      date: (data.get('date') as string) || '',
      categories: ((data.get('categories') as string) || '').split(',').map(c => c.trim()).filter(c => c),
      published: data.get('published') === 'on',
      thumbnail: (data.get('thumbnail') as string) || '',
      content: (data.get('content') as string) || ''
    };

    const errors = validatePostData(postData);
    
    if (errors.length === 0) {
      const success = await savePost(slug, postData);
      
      if (success) {
        message = 'Post updated successfully!';
        messageType = 'success';
        formData = { ...postData, categories: postData.categories.join(', ') };
      } else {
        message = 'Error updating post.';
        messageType = 'error';
      }
    } else {
      message = 'Validation errors: ' + errors.join(', ');
      messageType = 'error';
      formData = { ...postData, categories: postData.categories.join(', ') };
    }
  } catch (error) {
    console.error('Error updating post:', error);
    message = 'An error occurred while updating the post.';
    messageType = 'error';
  }
}
---

<AdminLayout title={`Edit: ${formData.title}`}>
  <div class="edit-post">
    <!-- Header con acciones -->
    <header class="page-header">
      <div class="header-main">
        <h1 class="page-title">Edit Post</h1>
        <p class="page-subtitle">
          <strong>Slug:</strong> <code>{slug}</code> ‚Ä¢ 
          <strong>File:</strong> <code>src/content/posts/{slug}.md</code>
        </p>
      </div>
      <div class="header-actions">
        <a href={`/posts/${slug}`} target="_blank" class="admin-btn secondary">
          <span>üëÅÔ∏è</span> Preview
        </a>
        <a href="/admin/posts" class="admin-btn secondary">
          ‚Üê Posts
        </a>
      </div>
    </header>

    <!-- Mensaje de estado -->
    {message && (
      <div class={`admin-alert ${messageType}`}>
        {message}
      </div>
    )}

    <!-- Formulario de edici√≥n -->
    <div class="edit-layout">
      <form method="POST" class="edit-form">
        <!-- Contenido principal -->
        <div class="content-section">
          <div class="admin-card">
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label for="title" class="admin-form-label">Title *</label>
                <input 
                  type="text" 
                  id="title" 
                  name="title" 
                  class="admin-form-input"
                  value={formData.title}
                  required 
                  placeholder="Enter post title"
                />
                <small class="admin-form-help">
                  ‚ö†Ô∏è Changing the title won't change the slug (filename)
                </small>
              </div>

              <div class="admin-form-group">
                <label for="description" class="admin-form-label">Description *</label>
                <textarea 
                  id="description" 
                  name="description" 
                  class="admin-form-textarea"
                  rows="3"
                  required 
                  placeholder="Brief description of the post"
                >{formData.description}</textarea>
                <small class="admin-form-help">This will appear in post cards and meta description</small>
              </div>

              <div class="admin-form-group">
                <label for="content" class="admin-form-label">Content *</label>
                <textarea 
                  id="content" 
                  name="content" 
                  class="admin-form-textarea content-editor"
                  required 
                  placeholder="Write your post content in Markdown..."
                >{formData.content}</textarea>
                <small class="admin-form-help">
                  You can use Markdown syntax. Images: ![alt](src), Links: [text](url)
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar con metadatos -->
        <aside class="sidebar-section">
          <!-- Publication settings -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3>üìÖ Publication</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label for="date" class="admin-form-label">Publication Date</label>
                <input 
                  type="date" 
                  id="date" 
                  name="date" 
                  class="admin-form-input"
                  value={formData.date}
                  required 
                />
              </div>

              <div class="admin-form-group">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    name="published" 
                    checked={formData.published}
                  />
                  <span class="checkmark"></span>
                  Published
                </label>
                <small class="admin-form-help">Uncheck to save as draft</small>
              </div>
            </div>
          </div>

          <!-- Categorization -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3>üè∑Ô∏è Categorization</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label for="categories" class="admin-form-label">Categories</label>
                <input 
                  type="text" 
                  id="categories" 
                  name="categories" 
                  class="admin-form-input"
                  value={formData.categories}
                  placeholder="black metal, ideas, m√∫sica"
                />
                <small class="admin-form-help">Separate multiple categories with commas</small>
              </div>

              <div class="admin-form-group">
                <label for="thumbnail" class="admin-form-label">Thumbnail URL</label>
                <input 
                  type="url" 
                  id="thumbnail" 
                  name="thumbnail" 
                  class="admin-form-input"
                  value={formData.thumbnail}
                  placeholder="/img/thumbnails/post.jpg"
                />
                <small class="admin-form-help">Optional: URL to post thumbnail image</small>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3>üíæ Actions</h3>
            </div>
            <div class="admin-card-body">
              <div class="action-buttons">
                <button type="submit" class="admin-btn">
                  Update Post
                </button>
                <a href="/admin/posts" class="admin-btn secondary">
                  Cancel
                </a>
              </div>
            </div>
          </div>

          <!-- Danger zone -->
          <div class="admin-card danger-zone">
            <div class="admin-card-header">
              <h3>‚ö†Ô∏è Danger Zone</h3>
            </div>
            <div class="admin-card-body">
              <p class="danger-text">This action cannot be undone. The post file will be permanently deleted.</p>
              <form method="POST" action="/admin/posts" onsubmit="return confirm('Are you sure you want to delete this post? This action cannot be undone.')">
                <input type="hidden" name="action" value="delete" />
                <input type="hidden" name="slug" value={slug} />
                <button type="submit" class="admin-btn danger">
                  üóëÔ∏è Delete Post
                </button>
              </form>
            </div>
          </div>
        </aside>
      </form>
    </div>

    <!-- Markdown help -->
    <div class="admin-card markdown-help">
      <div class="admin-card-header">
        <h3>üìù Markdown Quick Reference</h3>
      </div>
      <div class="admin-card-body">
        <div class="help-grid">
          <div class="help-item">
            <strong>Headers:</strong><br>
            <code># H1</code>, <code>## H2</code>, <code>### H3</code>
          </div>
          <div class="help-item">
            <strong>Text:</strong><br>
            <code>**bold**</code>, <code>*italic*</code>, <code>`code`</code>
          </div>
          <div class="help-item">
            <strong>Links:</strong><br>
            <code>[text](url)</code>, <code>![alt](image.jpg)</code>
          </div>
          <div class="help-item">
            <strong>Lists:</strong><br>
            <code>- Item 1</code>, <code>1. Numbered</code>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .edit-post {
    max-width: 100%;
  }

  /* Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 25px;
    gap: 20px;
  }

  .header-main {
    flex: 1;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
  }

  /* Layout principal - 70/30 split */
  .edit-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 25px;
    align-items: start;
  }

  .content-section {
    min-width: 0; /* Para que el textarea no se desborde */
  }

  .sidebar-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Editor de contenido */
  .content-editor {
    min-height: 500px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    resize: vertical;
  }

  /* Checkbox personalizado */
  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    gap: 8px;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  /* Action buttons */
  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .action-buttons .admin-btn {
    justify-content: center;
  }

  /* Danger zone */
  .danger-zone {
    border-color: var(--admin-danger);
  }

  .danger-zone .admin-card-header {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--admin-danger);
  }

  .danger-text {
    font-size: 12px;
    color: var(--admin-text-secondary);
    margin-bottom: 15px;
    line-height: 1.4;
  }

  /* Markdown help */
  .markdown-help {
    margin-top: 30px;
  }

  .help-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  .help-item {
    font-size: 12px;
  }

  .help-item strong {
    color: var(--admin-primary);
    display: block;
    margin-bottom: 5px;
  }

  .help-item code {
    background-color: var(--admin-bg-secondary);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 11px;
    margin-right: 5px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .edit-layout {
      grid-template-columns: 1fr;
    }

    .sidebar-section {
      order: -1; /* Sidebar primero en m√≥vil */
    }
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }

    .header-actions {
      justify-content: center;
    }

    .help-grid {
      grid-template-columns: 1fr;
    }
  }
</style>